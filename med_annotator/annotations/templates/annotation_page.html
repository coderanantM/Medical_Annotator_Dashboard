{% extends 'base.html' %}
{% load dict_helpers %}

{% block content %}

{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<style>
.clinical-wrapper { max-width: 1200px; margin: 0 auto; padding: 20px; font-family: 'Segoe UI', system-ui; }
.patient-header { background: #fff; border: 1px solid #dee2e6; border-radius: 10px; padding: 20px 30px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
.stage-section { margin-bottom: 50px; }
.stage-label { font-size: 1.25rem; font-weight: 700; color: #2c3e50; border-left: 5px solid #0d6efd; padding-left: 15px; margin-bottom: 20px; text-transform: uppercase; }
.img-wrapper { width: 100%; height: 340px; background: #000; display: flex; align-items: center; justify-content: center; border-radius: 12px; overflow: hidden; cursor: zoom-in; }
.img-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform .25s ease; }
.img-wrapper:hover img { transform: scale(1.25); }
.clinical-card { background: #fff; border: 1px solid #dee2e6; border-radius: 15px; padding: 40px; margin-top: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); }
.card-title { font-size: 1.5rem; font-weight: 700; border-bottom: 2px solid #f8f9fa; padding-bottom: 15px; margin-bottom: 30px; }
.comment-area textarea { width: 100%; min-height: 150px; border-radius: 10px; border: 1px solid #ced4da; padding: 15px; background: #fafafa; }
</style>

<div class="clinical-wrapper">

    <!-- Header -->
    <div class="patient-header shadow-sm">
        <h3 class="mb-0">
            Patient Case:
            <span class="text-primary">{{ patient.patient_id }}</span>
        </h3>
        <div class="d-flex gap-2">
            <a href="?sync=true" class="btn btn-outline-info">
                Refresh from Drive
            </a>
        </div>
    </div>
    <!-- Navigation Buttons -->
<div class="d-flex justify-content-between mb-4">
    {% if prev_patient_id %}
        <a href="{% url 'annotation_queue' %}?patient_id={{ prev_patient_id }}" class="btn btn-outline-secondary">
            &laquo; Previous
        </a>
    {% else %}
        <span class="btn btn-outline-secondary disabled">&laquo; Previous</span>
    {% endif %}
    {% if next_patient_id %}
        <a href="{% url 'annotation_queue' %}?patient_id={{ next_patient_id }}" class="btn btn-outline-primary">
            Next &raquo;
        </a>
    {% else %}
        <span class="btn btn-outline-primary disabled">Next &raquo;</span>
    {% endif %}
</div>

    <!-- Images -->
    {% for stage in stages %}
    <div class="stage-section">
        <div class="stage-label">{{ stage }} Phase</div>

        <div class="row g-4">
            {% with imgs=image_groups|dict_get:stage %}
                {% if imgs %}
                    {% for img in imgs %}
                    <div class="col-md-6">
                        <div class="img-wrapper shadow-sm bg-white">
                            <img src="{{ img.image_url }}"
                                 alt="{{ patient.patient_id }} {{ stage }}"
                                 loading="lazy"
                                 referrerpolicy="no-referrer"
                                 onerror="this.closest('.img-wrapper').style.display='none'">
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-light text-center py-5 border">
                            No images available for this phase.
                        </div>
                    </div>
                {% endif %}
            {% endwith %}
        </div>
    </div>
    {% endfor %}

    <!-- Annotation Form -->
    <div class="clinical-card">
        <div class="card-title">Clinical Assessment</div>

        <form method="post" action="{% url 'annotation_queue' %}">
            {% csrf_token %}
            <input type="hidden" name="annotation_id" value="{{ annotation.id }}">

            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="fw-bold mb-2">Vasculitis Presence</label>
                    <div class="p-3 border rounded bg-light">
                        {{ form.vasculitis_present }}
                        <span class="ms-2">Check if visible</span>
                    </div>
                </div>

                <div class="col-md-6">
                    <label class="fw-bold mb-2">Disease Activity Score</label>
                    {{ form.activity }}
                </div>
            </div>

            <div class="mb-4">
                <label class="fw-bold mb-2">
                    Image Quality (1â€“10):
                    <span id="val-display" class="text-primary">
                        {{ annotation.quality|default:"5" }}
                    </span>
                </label>
                {{ form.quality }}
            </div>

            <!-- Previous annotation (read-only) -->
            {% if previous_annotation and previous_annotation.comment %}
                <div class="alert alert-info mb-4">
                    <strong>Previous User:</strong>
                    {% if previous_annotation.user.get_full_name %}
                        {{ previous_annotation.user.get_full_name }} ({{ previous_annotation.user.username }})
                    {% else %}
                        {{ previous_annotation.user.username }}
                    {% endif %}
                    <br>
                    <strong>Date:</strong> {{ previous_annotation.annotated_at|date:"Y-m-d" }}<br>
                    <strong>Comment:</strong> {{ previous_annotation.comment }}
                </div>
            {% endif %}

            

            <!-- New comment -->
            <div class="comment-area mb-4">
                <label class="fw-bold mb-2">Additional Clinical Observations</label>
                {{ form.comment }}
            </div>

            <div class="d-flex justify-content-between mt-5 pt-3 border-top">
                <a href="{% url 'annotation_queue' %}" class="btn btn-link text-muted">
                    Exit
                </a>
                <div class="d-flex gap-3">
                    <button type="submit" name="action" value="save"
                        class="btn btn-outline-primary px-5">
                        Save
                    </button>
                    <button type="submit" name="action" value="save_and_next"
                        class="btn btn-success px-5">
                        Submit & Next
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const slider = document.getElementById('id_quality');
    const display = document.getElementById('val-display');
    if (slider) {
        slider.addEventListener('input', e => {
            display.innerText = e.target.value;
        });
    }
});
</script>

{% endblock %}
